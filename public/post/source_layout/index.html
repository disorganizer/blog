<!DOCTYPE html>
<html lang="en-us">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Don&#39;t panic">

<base href="https://disorganizer.github.io/blog">
<title>


     Source Layout 

</title>
<link rel="canonical" href="https://disorganizer.github.io/blog/post/source_layout/">


<script type="text/javascript">
    var baseURL = 'https:\/\/disorganizer.github.io\/blog';
    var host = baseURL.substring(0, baseURL.length - 1).replace(/\//g, '');
    if ((host === window.location.host) && (window.location.protocol !== 'https:')) {
        window.location.protocol = 'https:';
    }
</script>





<link rel="stylesheet" href="https://disorganizer.github.io/blog/css/reset.css">
<link rel="stylesheet" href="https://disorganizer.github.io/blog/css/pygments.css">
<link rel="stylesheet" href="https://disorganizer.github.io/blog/css/main.css">






<link rel="shortcut icon"

    href="https://disorganizer.github.io/blog/img/favicon.ico"

>



</head>


<body lang="en">

<section class="header"> 
    <div class="container">
        <div class="content">
            <a href="https://disorganizer.github.io/blog/"><div class="name">Chris Pahl</div></a>
            <nav>
                <ul>
                    <a href="https://disorganizer.github.io/blog/blog/"><li>Blog</li></a>
                    <a href="https://disorganizer.github.io/blog/about/"><li>About</li></a>
                    <a href="https://disorganizer.github.io/blog/code/"><li>Code</li></a>
                </ul>
            </nav>
        </div>
    </div>
</section>

<section class="icons">
    <div class="container">
        <div class="content">

        
            <a href="//github.com/sahib" target="_blank">
                <i class="icon ion-social-github"></i>
            </a>
        
        
        

        

        

        

        
            <a href="mailto:sahib@online.de">
                <i class="icon ion-ios-email larger"></i>
            </a>
        
        </div>
    </div>
</section>

<section class="main">
    <div class="container">
        <div class="content">
            <p>Hi there. Today&rsquo;s blog post is a unsorted notepad of how <code>brig</code>&rsquo;s source is
currently layout and what the big picture behind is supposed to look like.</p>

<p>Now that <code>brig</code> is already a mid-sized codebase (when did we get to 7k lines
of code?), it might be worthwhile to show what packages we have and how they
interact. Here&rsquo;s the <code>tree(1)</code> output of the git repository at the time of
writing. I allowed myself to reduce it to the most relevant files, also skipping
tests and rather unimportant subdirectories:</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>$ tree <span style="color: #f8f8f2">|</span> grep -v <span style="color: #e6db74">&#39;unimportant&#39;</span> .
â”œâ”€â”€ doc.go            <span style="color: #75715e"># Top-level documentation.</span>
â”œâ”€â”€ Makefile          <span style="color: #75715e"># Makefile with often used tools.</span>
â”œâ”€â”€ brig              <span style="color: #75715e"># Source of the `brig` binary...</span>
â”‚Â Â  â””â”€â”€ brig.go       <span style="color: #75715e"># ...which just calls into cmdline.*</span>
â”œâ”€â”€ cmdline           <span style="color: #75715e"># Actual implementation of the cli.</span>
â”‚Â Â  â”œâ”€â”€ handlers.go   <span style="color: #75715e"># Handler function for each subcommand.</span>
â”‚Â Â  â””â”€â”€ parser.go     <span style="color: #75715e"># Subcommand definitions are in here.</span>
â”œâ”€â”€ daemon            <span style="color: #75715e"># Implement the daemon/client process and io.</span>
â”‚Â Â  â”œâ”€â”€ client.go     <span style="color: #75715e"># client side daemon io.</span>
â”‚Â Â  â”œâ”€â”€ server.go     <span style="color: #75715e"># Server side daemon io.</span>
â”‚Â Â  â”œâ”€â”€ handlers.go   <span style="color: #75715e"># Server handler for each daemon command.</span>
â”‚Â Â  â””â”€â”€ operations.go <span style="color: #75715e"># Client handler for each daemon command.</span>
â”œâ”€â”€ fuse              <span style="color: #75715e"># Implementation of `brigfs`</span>
â”‚Â Â  â”œâ”€â”€ directory.go  <span style="color: #75715e"># Logic for directory nodes.</span>
â”‚Â Â  â”œâ”€â”€ entry.go      <span style="color: #75715e"># Logic for regular files.</span>
â”‚Â Â  â”œâ”€â”€ handle.go     <span style="color: #75715e"># Logic for open()&#39;d nodes.</span>
â”‚Â Â  â”œâ”€â”€ fs.go         <span style="color: #75715e"># Filesystem entry; defines the root node.</span>
â”‚Â Â  â””â”€â”€ mount.go      <span style="color: #75715e"># Mount utility.</span>
â”œâ”€â”€ im                <span style="color: #75715e"># XMPP communication layer.</span>
â”‚Â Â  â”œâ”€â”€ client.go     <span style="color: #75715e"># A generic otr-enabled xmpp client.</span>
â”‚Â Â  â”œâ”€â”€ finger.go     <span style="color: #75715e"># Fingerprint and key storage of each user.</span>
â”œâ”€â”€ repo              <span style="color: #75715e"># Code for filesystem repository handling.</span>
â”‚Â Â  â”œâ”€â”€ config/       <span style="color: #75715e"># Config value retrieval and default config.</span>
â”‚Â Â  â”œâ”€â”€ global/       <span style="color: #75715e"># Global config handling (~/.brig/)</span>
â”‚Â Â  â”œâ”€â”€ id.go         <span style="color: #75715e"># File locking (TODO: move to open.go?)</span>
â”‚Â Â  â”œâ”€â”€ init.go       <span style="color: #75715e"># Code to initialize a new empty repo.</span>
â”‚Â Â  â”œâ”€â”€ locate.go     <span style="color: #75715e"># Tool to find the repo root path.</span>
â”‚Â Â  â”œâ”€â”€ open.go       <span style="color: #75715e"># Code to lock/unlock a repository.</span>
â”‚Â Â  â”œâ”€â”€ pwd.go        <span style="color: #75715e"># Password handling.</span>
â”‚Â Â  â””â”€â”€ repo.go       <span style="color: #75715e"># The repository structure itself.</span>
â”œâ”€â”€ store             <span style="color: #75715e"># The actual core: file structs and ipfs handling.</span>
â”‚Â Â  â”œâ”€â”€ compress/     <span style="color: #75715e"># Seekable compression IO Layer using snappy.</span>
â”‚Â Â  â”œâ”€â”€ encrypt/      <span style="color: #75715e"># Seekable encryption IO Layer.</span>
â”‚Â Â  â”œâ”€â”€ format-util/  <span style="color: #75715e"># Compress&amp;Encryption util for brigs file format.</span>
â”‚Â Â  â”œâ”€â”€ commit.go     <span style="color: #75715e"># Versioning handling.</span>
â”‚Â Â  â”œâ”€â”€ file.go       <span style="color: #75715e"># Implement the file struct and the implicit trie.</span>
â”‚Â Â  â”œâ”€â”€ hash.go       <span style="color: #75715e"># wrapper around jbenet/multihash&#39;s implementation.</span>
â”‚Â Â  â”œâ”€â”€ index.go      <span style="color: #75715e"># Implementation of add/rm/cat/checkout...</span>
â”‚Â Â  â”œâ”€â”€ overlay.go    <span style="color: #75715e"># A write overlay of a immutable io.Reader for fuse.</span>
â”‚Â Â  â”œâ”€â”€ stream.go     <span style="color: #75715e"># Stack encryption and compression.</span>
â”œâ”€â”€ util              <span style="color: #75715e"># General utilities.</span>
â”‚Â Â  â”œâ”€â”€ colors/       <span style="color: #75715e"># ASCII-terminal color code colorizing.</span>
â”‚Â Â  â”œâ”€â”€ filelock/     <span style="color: #75715e"># Filelocking (used for the global repo)</span>
â”‚Â Â  â”œâ”€â”€ ipfsutil/     <span style="color: #75715e"># Utils around the ipfs libraries.</span>
â”‚Â Â  â”œâ”€â”€ log/          <span style="color: #75715e"># A colorful log-formatter for `logrus`</span>
â”‚Â Â  â”œâ”€â”€ security/     <span style="color: #75715e"># security related utilites (scrypt simplified)</span>
â”‚Â Â  â”œâ”€â”€ testutil/     <span style="color: #75715e"># Utils used in various tests.</span>
â”‚Â Â  â”œâ”€â”€ trie/         <span style="color: #75715e"># A re-usable radix-trie for absolute file paths.</span>
â”‚Â Â  â”œâ”€â”€ tunnel/       <span style="color: #75715e"># An io.ReadWriter that pipes through ECDH and AES.</span>
â”‚Â Â  â””â”€â”€ std.go        <span style="color: #75715e"># Standard utils that should be in the standard lib.</span>
â””â”€â”€ version.go        <span style="color: #75715e"># Semantic versioning of the brig util/library.</span>
</pre></div>


<p>You might already have an idea how <code>brig</code> is working by now. There&rsquo;s a
command-line utility that speaks to a daemon that was somehow started, which
uses a store to <code>add</code> and <code>cat</code> files. The daemon is also capable of mounting
a fuse filesystem, but before that it needs a repository to run in.
That&rsquo;s the very rough picture, but to recap this we have this diagram to show
how the most important packages play together:</p>

<p><img src="https://disorganizer.github.io/blog/img/package_map.svg" alt="Package map" width="800px"/></p>

<p>From a slightly wider view, the communication between two repositories
is supposed too look like this:</p>

<p><img src="https://disorganizer.github.io/blog/img/brig_arch.svg" alt="Security architecture" width="800px"/></p>

<p>I don&rsquo;t have any details to show here, simply because there is nothing to show
yet: The inter-repository communication simply does not exist yet. ðŸ˜‰</p>

<p>What&rsquo;s working now is mostly the fuse part (well, mostly, it already works like
a buggy and slow <code>encfs</code>) and the versioning. Naturally the next goal is
to exchange some information between two <code>brig</code> nodes.
The cool thing about the current architecture is naturally that we don&rsquo;t need to
do any file exchange or storage ourselves, since <code>ipfs</code> handles that for us.
As long as we manage to get the hashes and keys across XMPP, we successfully
share files - <code>ipfs</code> will make sure to load it from the swarm.</p>

<p>It&rsquo;s late here, so that&rsquo;s it for today.</p>

        </div>
    </div>
</section>




</body>
</html>

