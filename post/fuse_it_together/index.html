<!DOCTYPE html>
<html lang="en-us">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Don&#39;t panic">

<base href="https://disorganizer.github.io/blog">
<title>


     Fusing it together 

</title>
<link rel="canonical" href="https://disorganizer.github.io/blog/post/fuse_it_together/">


<script type="text/javascript">
    var baseURL = 'https:\/\/disorganizer.github.io\/blog';
    var host = baseURL.substring(0, baseURL.length - 1).replace(/\//g, '');
    if ((host === window.location.host) && (window.location.protocol !== 'https:')) {
        window.location.protocol = 'https:';
    }
</script>





<link rel="stylesheet" href="https://disorganizer.github.io/blog/css/reset.css">
<link rel="stylesheet" href="https://disorganizer.github.io/blog/css/pygments.css">
<link rel="stylesheet" href="https://disorganizer.github.io/blog/css/main.css">






<link rel="shortcut icon"

    href="https://disorganizer.github.io/blog/img/favicon.ico"

>



</head>


<body lang="en">

<section class="header"> 
    <div class="container">
        <div class="content">
            <a href="https://disorganizer.github.io/blog/"><div class="name">Chris Pahl</div></a>
            <nav>
                <ul>
                    <a href="https://disorganizer.github.io/blog/blog/"><li>Blog</li></a>
                    <a href="https://disorganizer.github.io/blog/about/"><li>About</li></a>
                    <a href="https://disorganizer.github.io/blog/code/"><li>Code</li></a>
                </ul>
            </nav>
        </div>
    </div>
</section>

<section class="icons">
    <div class="container">
        <div class="content">

        
            <a href="//github.com/sahib" target="_blank">
                <i class="icon ion-social-github"></i>
            </a>
        
        
        

        

        

        

        
            <a href="mailto:sahib@online.de">
                <i class="icon ion-ios-email larger"></i>
            </a>
        
        </div>
    </div>
</section>

<section class="main">
    <div class="container">
        <div class="content">
            <p>Another productive day, another update late in the night.</p>

<p>A basic FUSE layer is integrated and is already able to display
the contents of a <code>util.trie.Trie</code> as files and directories.
Reading and writing is not yet implemented, since that&rsquo;s the
part where fuse and brig actually need to&hellip; fuse.</p>

<p>Here&rsquo;s a small session inside the fuse layer:</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>λ ~ → brig mount /tmp/mount <span style="color: #f92672">&amp;&amp;</span> <span style="color: #f8f8f2">cd</span> /tmp/mount
λ /tmp/mount → touch hello  <span style="color: #75715e"># Creating file work. </span>
λ /tmp/mount → cat hello    <span style="color: #75715e"># Although they contain weird stuff.</span>
NaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNa
NaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNa
NaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNaNa
NaNaNaNaNaNaNaNaNaNaNaNaNa%
λ /tmp/mount → stat hello   <span style="color: #75715e"># Every file is 200 bytes in size currently.</span>
File: „hello“
<span style="color: #f92672">(</span>...<span style="color: #f92672">)</span> Size: <span style="color: #ae81ff">200</span>  <span style="color: #f92672">(</span>...<span style="color: #f92672">)</span>
λ /tmp/mount → ls           <span style="color: #75715e"># Also enumerating the directory.</span>
hello  <span style="color: #f8f8f2">test</span>
λ /tmp/mount → mkdir new    <span style="color: #75715e"># Adding directories even somehow works.</span>
hello  new  <span style="color: #f8f8f2">test</span>
$ brig mount -u /tmp/mount
</pre></div>


<p>It already feels like a pretty normal directory. Most of it&rsquo;s code is inspired
from bolt-mount, which is described in this
<a href="http://eagain.net/talks/bolt-mount/">video</a>.
As you may have noticed <code>mount</code> and <code>mount -u</code> are daemon commands already.
The only thing left to do now, is to read the actual stream and display
<code>store.Trie</code>.</p>

<p>There was another small change which might have larger impact. Instead of generating
the AES-key from the hash of the first 8KB of a file, the key is randomly generated now
and stored in the index. This is probably saner/faster/more secure. But the actual
reason for this is: When modifying the file, the key might need to change, which
required re-encrypting the file, which in turn is very expensive.
For the prototype we probably need to re-add every file to <code>ipfs</code> anyways, but now
we have more space for optimisations later on.</p>

<p>Another nicety is that <code>brig add</code> now works on directories. It simply adds all
files in it and <code>brig mkdir</code> all directories. Also missing <code>/</code> are prefixed
automatically and the repo path can be guessed from the source path.</p>

<p>As usual, a list of targets for the next entry follows (this evolves into my TODO-list&hellip;):</p>

<ul>
<li>Add <code>brig rm</code> which does obvious things.</li>
<li>Make sure trie modifications in the index are locked.</li>
<li>Read relevant metadata from the source file (size, mtime, etc.)</li>
<li>Fix my sleep schedule.</li>
</ul>

        </div>
    </div>
</section>




</body>
</html>

