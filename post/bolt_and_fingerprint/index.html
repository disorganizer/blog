<!DOCTYPE html>
<html lang="en-us">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Don&#39;t panic">

<base href="https://disorganizer.github.io/blog">
<title>


     Stacking closures and more 

</title>
<link rel="canonical" href="https://disorganizer.github.io/blog/post/bolt_and_fingerprint/">


<script type="text/javascript">
    var baseURL = 'https:\/\/disorganizer.github.io\/blog';
    var host = baseURL.substring(0, baseURL.length - 1).replace(/\//g, '');
    if ((host === window.location.host) && (window.location.protocol !== 'https:')) {
        window.location.protocol = 'https:';
    }
</script>





<link rel="stylesheet" href="https://disorganizer.github.io/blog/css/reset.css">
<link rel="stylesheet" href="https://disorganizer.github.io/blog/css/pygments.css">
<link rel="stylesheet" href="https://disorganizer.github.io/blog/css/main.css">






<link rel="shortcut icon"

    href="https://disorganizer.github.io/blog/img/favicon.ico"

>



</head>


<body lang="en">

<section class="header"> 
    <div class="container">
        <div class="content">
            <a href="https://disorganizer.github.io/blog/"><div class="name">Chris Pahl</div></a>
            <nav>
                <ul>
                    <a href="https://disorganizer.github.io/blog/blog/"><li>Blog</li></a>
                    <a href="https://disorganizer.github.io/blog/about/"><li>About</li></a>
                    <a href="https://disorganizer.github.io/blog/code/"><li>Code</li></a>
                </ul>
            </nav>
        </div>
    </div>
</section>

<section class="icons">
    <div class="container">
        <div class="content">

        
            <a href="//github.com/sahib" target="_blank">
                <i class="icon ion-social-github"></i>
            </a>
        
        
        

        

        

        

        
            <a href="mailto:sahib@online.de">
                <i class="icon ion-ios-email larger"></i>
            </a>
        
        </div>
    </div>
</section>

<section class="main">
    <div class="container">
        <div class="content">
            <p>A bit more than one day after the last post. Not too bad.
Basically, three smaller things happened since the last time.</p>

<p>First, we now store files serialized as protobufs in the index persistently.
The index is just a BoltDB database file (which I can recommend, it&rsquo;s nice).</p>

<p>Secondly, the AES-key for each file is generated from the <code>sha512</code> hash of the
first 8KB of a file. We don&rsquo;t hash the full file for performance reasons, but
there is nothing stopping us from hashing the whole file, so we fully apply to
<a href="https://en.wikipedia.org/wiki/Convergent_encryption">Wikipedia&rsquo;s definiton of convergent
encryption</a>. The hash is
then processed by <code>scrypt</code> with the filesize as salt. Currently, the key is
also stored in the index.</p>

<p>Finally, the commandline interface was cleared up a bit.
We now use the <code>withXY</code> pattern which are usually popular in tests.
Since we use <code>climax</code> as commandline library, we need to pass a callback
handle for each subcommand we have (<code>add</code>, <code>cat</code>, etc.).
Almost all of them have in common that they need to talk to the daemon
and need a certain number of arguments to work.</p>

<p>It would be nice to write something like this:</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #75715e">// ...</span>
<span style="color: #a6e22e">Handle</span><span style="color: #f8f8f2">:</span> <span style="color: #a6e22e">withArgCheck</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">needAtLeast</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">),</span> <span style="color: #a6e22e">withDaemon</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">handleAdd</span><span style="color: #f8f8f2">)),</span>
<span style="color: #75715e">// ...</span>
</pre></div>


<p>&hellip; which is nicely possible by writing a function that returns a closure:</p>

<p><div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">type</span> <span style="color: #a6e22e">CheckFunc</span> <span style="color: #66d9ef">func</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">ctx</span> <span style="color: #a6e22e">climax</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">Context</span><span style="color: #f8f8f2">)</span> <span style="color: #66d9ef">int</span>

<span style="color: #66d9ef">func</span> <span style="color: #a6e22e">withArgCheck</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">checker</span> <span style="color: #a6e22e">CheckFunc</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">handler</span> <span style="color: #a6e22e">climax</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">CmdHandler</span><span style="color: #f8f8f2">)</span> <span style="color: #a6e22e">climax</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">CmdHandler</span> <span style="color: #f8f8f2">{</span>
	<span style="color: #66d9ef">return</span> <span style="color: #66d9ef">func</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">ctx</span> <span style="color: #a6e22e">climax</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">Context</span><span style="color: #f8f8f2">)</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">{</span>
		<span style="color: #66d9ef">if</span> <span style="color: #a6e22e">checker</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">ctx</span><span style="color: #f8f8f2">)</span> <span style="color: #f92672">!=</span> <span style="color: #a6e22e">Success</span> <span style="color: #f8f8f2">{</span>
			<span style="color: #66d9ef">return</span> <span style="color: #a6e22e">BadArgs</span>
		<span style="color: #f8f8f2">}</span>

		<span style="color: #66d9ef">return</span> <span style="color: #a6e22e">handler</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">ctx</span><span style="color: #f8f8f2">)</span>
	<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">func</span> <span style="color: #a6e22e">needAtLeast</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">min</span> <span style="color: #66d9ef">int</span><span style="color: #f8f8f2">)</span> <span style="color: #a6e22e">CheckFunc</span> <span style="color: #f8f8f2">{</span>
	<span style="color: #66d9ef">return</span> <span style="color: #66d9ef">func</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">ctx</span> <span style="color: #a6e22e">climax</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">Context</span><span style="color: #f8f8f2">)</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">{</span>
		<span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">len(</span><span style="color: #a6e22e">ctx</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">Args</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">&lt;</span> <span style="color: #a6e22e">min</span> <span style="color: #f8f8f2">{</span>
			<span style="color: #a6e22e">log</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">Warningf</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;Need at least %d arguments.&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">min</span><span style="color: #f8f8f2">)</span>
			<span style="color: #66d9ef">return</span> <span style="color: #a6e22e">BadArgs</span>
		<span style="color: #f8f8f2">}</span>

		<span style="color: #66d9ef">return</span> <span style="color: #a6e22e">Success</span>
	<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
</pre></div>
</p>

<p>Oh, as an extra: We&rsquo;re on GitHub now:</p>

<ul>
<li><a href="https://github.com/disorganizer">https://github.com/disorganizer</a> (source)</li>
<li><a href="https://disorganizer.github.io/blog/index.html">https://disorganizer.github.io/blog/index.html</a> (blog)</li>
</ul>

<p>That&rsquo;s it for now. The next days should bring some of the following:</p>

<ul>
<li>Make the index remember directories.</li>
<li>Recursively add directories.</li>
<li>A humble start on the FUSE layer.</li>
</ul>

        </div>
    </div>
</section>




</body>
</html>

